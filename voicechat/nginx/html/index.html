<!DOCTYPE html>
<html>
<head>
    <title>Voice Chat</title>
</head>
<body>
    <h1>Voice Chat</h1>
    <script>
        // Set the time threshold for silence detection (in milliseconds)
        const silenceThreshold = 1000; 

        // Initialize variables for audio recording
        let mediaRecorder;
        let audioChunks = [];
        let silenceTimer;

        // Function to start recording audio
        async function startRecording() {
            try {
                // Request access to the user's microphone
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                // Event handler for data available
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                    resetSilenceTimer();
                };

                // Start the media recorder
                mediaRecorder.start();
                console.log("Recording started.");

                // Start the silence detection
                detectSilence();

            } catch (error) {
                console.error("Error accessing microphone:", error);
            }
        }

        // Function to stop recording and send audio
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                console.log("Recording stopped.");
                sendAudio();
            }
        }

        // Function to send audio data to the server
        function sendAudio() {
            if (audioChunks.length > 0) {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                
                // Create a FormData object to send the audio file
                const formData = new FormData();
                formData.append('audio', audioBlob);

                // Send the audio data to the server using fetch API
                fetch('/voice', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => {
                // Play received audio.
                    playAudio(arrayBuffer);
                })
                .catch(error => {
                    console.error("Error sending audio:", error);
                });
                // Clear the recorded audio chunks
                audioChunks = [];
            }
        }

        // Function to play the received audio
        function playAudio(arrayBuffer) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioContext.decodeAudioData(arrayBuffer).then(buffer => {
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);
                source.start();
            });
        }
        
        // Function to detect silence
        function detectSilence() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(mediaRecorder.stream);
            source.connect(analyser);
            analyser.fftSize = 2048;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const checkSilence = () => {
                analyser.getByteTimeDomainData(dataArray);
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += Math.abs(dataArray[i] - 128);
                }
                const average = sum / bufferLength;

                // Check if the average volume is below a certain threshold to detect silence
                if (average < 5) { 
                    if (!silenceTimer) {
                        silenceTimer = setTimeout(stopRecording, silenceThreshold);
                    }
                } else {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }

                requestAnimationFrame(checkSilence);
            };

            checkSilence();
        }

        // Function to reset the silence timer
        function resetSilenceTimer() {
            clearTimeout(silenceTimer);
            silenceTimer = null;
        }

        // Start recording when the page loads
        window.onload = () => {
            startRecording();
        };
    </script>
</body>
</html>
