<!DOCTYPE html>
<html>
<head>
    <title>Voice Chat</title>
    <style>
        #userInfo {
            margin-bottom: 10px;
        }
        #status {
            margin-bottom: 10px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Voice Chat</h1>
    <div id="userInfo" class="hidden">User ID: <span id="userId"></span></div>
    <div id="status">Status: <span id="statusText"></span></div>
    <button id="startButton" onclick="startRecording();">Start Recording</button>
    <button id="stopButton" onclick="stopRecording();" disabled>Stop Recording</button>

    <script>
        // Set the time threshold for silence detection (in milliseconds)
        const silenceThreshold = 1000;

        // Initialize variables for audio recording
        let mediaRecorder;
        let audioChunks = [];
        let silenceTimer;
        let userId;

        // Function to get user_id from URL
        function getUserIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('user_id');
        }

        // Function to update the status text
        function updateStatus(statusText) {
            document.getElementById('statusText').innerText = statusText;
        }

        // Function to start recording audio
        async function startRecording() {
            try {
                // Request access to the user's microphone
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                // Event handler for data available
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                    resetSilenceTimer();
                    updateStatus("Recording...");
                };

                // Event handler for when recording stops
                mediaRecorder.onstop = () => {
                    updateStatus("Recording stopped.");
                    document.getElementById('startButton').disabled = false;
                    document.getElementById('stopButton').disabled = true;
                };

                // Start the media recorder
                mediaRecorder.start();
                console.log("Recording started.");
                updateStatus("Recording...");
                document.getElementById('startButton').disabled = true;
                document.getElementById('stopButton').disabled = false;

                // Start the silence detection
                detectSilence();

            } catch (error) {
                console.error("Error accessing microphone:", error);
                updateStatus("Error: " + error.message);
            }
        }

        // Function to stop recording and send audio
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                console.log("Recording stopped.");
                sendAudio();
            }
        }

        // Function to send audio data to the server
        function sendAudio() {
            updateStatus("Sending audio...");
            if (audioChunks.length > 0) {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });

                // Create a FormData object to send the audio file and user_id
                const formData = new FormData();
                formData.append('audio', audioBlob);
                formData.append('user_id', userId);

                // Send the audio data to the server using fetch API
                fetch('https://10.20.30.4/voice', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => {
                    // Play received audio.
                    updateStatus("Audio sent. Playing received audio...");
                    playAudio(arrayBuffer);
                })
                .catch(error => {
                    console.error("Error sending/receiving audio:", error);
                    updateStatus("Error: " + error.message);
                });
                // Clear the recorded audio chunks
                audioChunks = [];
            } else {
                updateStatus("No audio to send.");
            }
        }

        // Function to play the received audio
        function playAudio(arrayBuffer) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioContext.decodeAudioData(arrayBuffer).then(buffer => {
                const source = audioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(audioContext.destination);
                source.start();
                updateStatus("Playing audio...");
            }).catch(error => {
                console.error("Error decoding audio data:", error);
                updateStatus("Error: " + error.message);
            });
        }

        // Function to detect silence
        function detectSilence() {
            if (typeof mediaRecorder === 'undefined' || typeof mediaRecorder.stream === 'undefined')
            {
                console.log("mediaRecorder or mediaRecorder.stream is not ready yet.");
                setTimeout(detectSilence, 500);
                return;
            }
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(mediaRecorder.stream);
            source.connect(analyser);
            analyser.fftSize = 2048;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const checkSilence = () => {
                analyser.getByteTimeDomainData(dataArray);
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += Math.abs(dataArray[i] - 128);
                }
                const average = sum / bufferLength;

                // Check if the average volume is below a certain threshold to detect silence
                if (average < 5) {
                    if (!silenceTimer) {
                        silenceTimer = setTimeout(stopRecording, silenceThreshold);
                    }
                } else {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }

                requestAnimationFrame(checkSilence);
            };

            checkSilence();
        }

        // Function to reset the silence timer
        function resetSilenceTimer() {
            clearTimeout(silenceTimer);
            silenceTimer = null;
        }

        // Start recording when the page loads
        window.onload = () => {
            userId = getUserIdFromURL();
            if (userId) {
                document.getElementById('userId').innerText = userId;
                document.getElementById('userInfo').classList.remove('hidden');
                updateStatus("Ready to record.");
            } else {
                console.error("User ID not found in URL.");
                updateStatus("Error: User ID not found in URL.");
            }
        };
    </script>
</body>
</html>
